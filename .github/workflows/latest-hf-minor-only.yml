name: Run Only on Latest HF and Minor Branches

on:
  push:
    branches:
      - 'profit_deployment*'

jobs:
  validate-latest-java:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current branch
        id: current
        run: echo "CURRENT_BRANCH=${GITHUB_REF##*/}" >> $GITHUB_ENV

      - name: Get latest HF and Minor branches
        run: |
          all_branches=$(git ls-remote --heads origin | awk '{print $2}' | sed 's|refs/heads/||')
          latest_hf=$(echo "$all_branches" | grep '^profit_deployment_hf_' | sort -Vr | head -n1)
          latest_minor=$(echo "$all_branches" | grep -E '^profit_deployment_[0-9]' | grep -v 'hf' | sort -Vr | head -n1)
          echo "LATEST_HF_BRANCH=$latest_hf" >> $GITHUB_ENV
          echo "LATEST_MINOR_BRANCH=$latest_minor" >> $GITHUB_ENV

      - name: Debug print branches
        run: |
          echo "üîç CURRENT_BRANCH: $CURRENT_BRANCH"
          echo "üì¶ LATEST_HF_BRANCH: $LATEST_HF_BRANCH"
          echo "üì¶ LATEST_MINOR_BRANCH: $LATEST_MINOR_BRANCH"

      - name: Stop if not latest
        run: |
          if [[ "$CURRENT_BRANCH" != "$LATEST_HF_BRANCH" && "$CURRENT_BRANCH" != "$LATEST_MINOR_BRANCH" ]]; then
            echo "‚õî Not the latest HF or Minor branch. Exiting."
            exit 1
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven
        run: |
          mvn clean compile
